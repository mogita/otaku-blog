<!DOCTYPE html>
<html lang="en">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>
  A Personal Mastodon Instance Setup · mogita
</title>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">




<meta name="author" content="Yun Wang">
<meta name="description" content="I’ve not always wanted to bring up a Mastodon instance for it was not that intriguing to me, until recently Musk has worked on Twitter in an amateur way.
On the other hand, to host an instance of my own is a way of paying tribute to the past ‘90s self-host Email compaign which I was too young and poor to have the chance to experience. At least for now, we are seeing a blooming new way of social networking, whether or not a long-term fight against spam and junk information in the future awaits.">
<meta name="keywords" content="blog,developer,personal">

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A Personal Mastodon Instance Setup"/>
<meta name="twitter:description" content="I’ve not always wanted to bring up a Mastodon instance for it was not that intriguing to me, until recently Musk has worked on Twitter in an amateur way.
On the other hand, to host an instance of my own is a way of paying tribute to the past ‘90s self-host Email compaign which I was too young and poor to have the chance to experience. At least for now, we are seeing a blooming new way of social networking, whether or not a long-term fight against spam and junk information in the future awaits."/>

<meta property="og:title" content="A Personal Mastodon Instance Setup" />
<meta property="og:description" content="I’ve not always wanted to bring up a Mastodon instance for it was not that intriguing to me, until recently Musk has worked on Twitter in an amateur way.
On the other hand, to host an instance of my own is a way of paying tribute to the past ‘90s self-host Email compaign which I was too young and poor to have the chance to experience. At least for now, we are seeing a blooming new way of social networking, whether or not a long-term fight against spam and junk information in the future awaits." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/a-personal-mastodon-instance-setup.html" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-22T12:57:46+08:00" />
<meta property="article:modified_time" content="2022-12-30T12:25:24+08:00" />





<link rel="canonical" href="http://localhost:1313/posts/a-personal-mastodon-instance-setup.html">


<link rel="preload" href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as="font" type="font/woff2" crossorigin>


  
  
  <link rel="stylesheet" href="/css/coder.css" media="screen">






  
    
    
    <link rel="stylesheet" href="/css/coder-dark.css" media="screen">
  



 




<link rel="icon" type="image/png" href="/img/favicons/favicon32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/img/favicons/favicon16.png" sizes="16x16">

<link rel="apple-touch-icon" href="/img/favicons/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/img/favicons/favicon.png">

<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#5bbad5">




<meta name="generator" content="Hugo 0.101.0" />





  </head>






<body class="preload-transitions colorscheme-auto">
  
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


  <main class="wrapper">
    <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      mogita
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Posts</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/index.xml">RSS</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/tags.html">Tags</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about.html">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


    <div class="content">
      
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">
            <a class="title-link" href="http://localhost:1313/posts/a-personal-mastodon-instance-setup.html">
              A Personal Mastodon Instance Setup
            </a>
          </h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime="2022-12-22T12:57:46&#43;08:00">
                December 22, 2022
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              3-minute read
            </span>
          </div>
          
          
          <div class="tags">
  <i class="fa fa-tag" aria-hidden="true"></i>
    <span class="tag">
      <a href="/tags/mastodon/">mastodon</a>
    </span>
      <span class="separator">•</span>
    <span class="tag">
      <a href="/tags/docker/">docker</a>
    </span></div>

        </div>
      </header>

      <div class="post-content">
        
        <p>I’ve not always wanted to bring up a Mastodon instance for it was not that intriguing to me, until recently Musk has worked on Twitter in an amateur way.</p>
<p>On the other hand, to host an instance of my own is a way of paying tribute to the past ‘90s self-host Email compaign which I was too young and poor to have the chance to experience. At least for now, we are seeing a blooming new way of social networking, whether or not a long-term fight against spam and junk information in the future awaits.</p>
<blockquote>
<p><a href="https://twitter.com/mogita/status/1605188553423536134">https://twitter.com/mogita/status/1605188553423536134</a></p>
</blockquote>
<p>I’ll open source my setup. You can skip to the Code section to see the project.</p>
<p>You can also check out my instance <a href="https://mog.blue/@mogita">@mogita@mog.blue</a>. I&rsquo;m always ready for a little chat.</p>
<h1 id="how-to-run">
  How To Run
  <a class="heading-link" href="#how-to-run">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I’m going to serve my Mastodon instance through Docker with <code>docker-compose</code> for an easier and consistent management workflow.</p>
<h1 id="what-to-include">
  What To Include
  <a class="heading-link" href="#what-to-include">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>Inside the <code>docker-compose.yml</code> file I’ll put these components:</p>
<ul>
<li>Mastodon web: <code>tootsuite/mastodon:latest</code> + ES analyzer tweak (for indexing non-English languages)</li>
<li>Database: <code>postgres:14-alpine</code></li>
<li>Redis: <code>redis:7-alpine</code></li>
<li>ElasticSearch: <code>elasticsearch:7.17.8</code> + <a href="https://github.com/medcl/elasticsearch-analysis-ik">ik</a> + <a href="https://github.com/medcl/elasticsearch-analysis-stconvert">stconvert</a></li>
<li>Streaming: <code>tootsuite/mastodon:latest</code></li>
<li>Sidekiq: <code>tootsuite/mastodon:latest</code></li>
<li>Nginx: <code>nginx:latest</code></li>
</ul>
<h1 id="es-analyzer-tweak">
  ES Analyzer Tweak
  <a class="heading-link" href="#es-analyzer-tweak">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>A vanilla Mastodon instance is fairly easy to setup from the basic versions of the said docker images. However, adding optimization for other languages in its search functionality requires code modification which would impair the simplicity of just following the minimum workflow. Hope this necessity can be replaced with a more proper way, like configurable through <code>.env</code>.</p>
<p>At the time of writing, there are 3 steps according to the <a href="https://docs.joinmastodon.org/admin/optional/elasticsearch/#search-optimization-for-other-languages">official documentation</a>:</p>
<ol>
<li>Install ES plugin <a href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></li>
<li>Install ES plugin <a href="https://github.com/medcl/elasticsearch-analysis-stconvert">https://github.com/medcl/elasticsearch-analysis-stconvert</a></li>
<li>Modify Mastodon’s source code on index definition</li>
</ol>
<p>Previous 2 steps can be achieved relatively easier. Just create a <code>Dockerfile</code> for a custom ES build and make the installation on the official ES image. Pay attention to the version consistency though.</p>
<p>As of step 3, I’ll <code>patch</code> the diff code provided by the documentation. Nonetheless a custom image is necessary too.</p>
<p>To sum up, I’ll need to build 2 images:</p>
<ul>
<li>A custom Mastodon image for: Mastodon web, Streaming and Sidekiq</li>
<li>A custom ElasticSearch image for: ElasticSearch with non-English languages support</li>
</ul>
<h1 id="miscellaneous">
  Miscellaneous
  <a class="heading-link" href="#miscellaneous">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<h2 id="https-support">
  HTTPS Support
  <a class="heading-link" href="#https-support">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>My Mastodon setup will enjoy the benefits from <code>nginx-proxy</code> and <code>acme-companion</code> for automatic SSL certificates challenging and renewal. This is why I have an Nginx component on the list. It’s the reverse proxy to handle SSL traffic.</p>
<h2 id="object-storage-support">
  Object Storage Support
  <a class="heading-link" href="#object-storage-support">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Using a cheap S3 compatible object storage service is my go-to plan on a minimum user base. Having it gone through a Cloudflare CDN might help with lowering the bandwidth cost too.</p>
<h2 id="email-relay">
  Email Relay
  <a class="heading-link" href="#email-relay">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Google Workplace SMTP relay service is my first choice since I’m on a business plan. For free alternatives, any relay service shall do and many offer a free amount for around 100 or more Emails per day.</p>
<h2 id="backups">
  Backups
  <a class="heading-link" href="#backups">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>Since the object storage will be used, the only critical thing to backup is the database. A script that sends a daily <code>pg_dump</code> archive to one of my storage service provider shall do. If things go crazy in the future, like I’ll need to host the instance for hundreds of users, then master-slave replica might be useful as an additional measurement.</p>
<h2 id="scaling">
  Scaling
  <a class="heading-link" href="#scaling">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h2>
<p>No need to consider right now. Cost effectivity, on the contrary, shall be my first priority given the instance being invitation only.</p>
<h1 id="code">
  Code
  <a class="heading-link" href="#code">
    <i class="fa fa-link" aria-hidden="true" title="Link to heading"></i>
    <span class="sr-only">Link to heading</span>
  </a>
</h1>
<p>I named my Mastodon setup project the <code>monsts</code>, it stands for “Mastodon Of Not So Typical Setup”.</p>
<p>You can browse the source code here: <a href="https://gitlab.com/mogita/monsts">https://gitlab.com/mogita/monsts</a></p>

      </div>


      <footer>
        


        <div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "otaku-mogita" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
    
    document.addEventListener('themeChanged', function (e) { 
        if (document.readyState == 'complete') {
          DISQUS.reset({ reload: true, config: disqus_config });
        }
    });
</script>
        
        
      </footer>
    </article>

    
  </section>

    </div>

    <footer class="footer">
  <section class="container">
    ©
    
      2010 -
    
    2022
     Yun Wang 
    ·
    
    Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
  </section>
</footer>

  </main>

  

  
  
  <script src="/js/coder.js"></script>
  

  

  

  

  

  

  

  

  

  
</body>

</html>
